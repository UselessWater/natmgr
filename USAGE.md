# NAT Manager 使用文档

NAT Manager 是一个基于 iptables 的 Linux NAT 端口转发管理工具。它提供了交互式菜单和命令行两种操作模式，简化了端口转发规则的配置和管理。

## 目录

1. [功能特性](#功能特性)
2. [安装要求](#安装要求)
3. [使用方式](#使用方式)
4. [功能详解](#功能详解)
5. [常见使用场景](#常见使用场景)
6. [故障排查](#故障排查)
7. [注意事项](#注意事项)
8. [卸载方法](#卸载方法)

---

## 功能特性

- **交互式菜单**：可视化操作界面，适合新手使用
- **命令行模式**：支持脚本化调用，适合自动化场景
- **规则持久化**：保存配置到文件，支持重启后自动恢复
- **操作日志**：记录所有操作，便于审计和排障
- **批量端口**：支持端口范围转发（如 Hysteria 的端口跳跃）
- **双向协议**：同时支持 TCP 和 UDP 协议

---

## 安装要求

### 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Linux (Debian/Ubuntu/CentOS 等) |
| 权限 | root 或 sudo |
| 依赖 | iptables |

### 依赖安装

```bash
# Debian/Ubuntu
sudo apt-get install -y iptables

# CentOS/RHEL
sudo yum install -y iptables
```

---

## 使用方式

### 交互式菜单

直接运行 `natmgr` 即可启动可视化菜单：

```bash
sudo natmgr
```

菜单界面：

```
╔════════════════════════════════════╗
║        NAT 端口转发管理器          ║
╚════════════════════════════════════╝

当前规则数: 2  |  配置: /etc/nat-manager.conf

  1) 查看当前规则
  2) 添加转发规则
  3) 删除转发规则
  4) 保存规则配置
  5) 恢复规则配置
  6) 查看操作日志
  0) 退出

请选择操作 [0-6]:
```

### 命令行模式

```bash
natmgr [命令] [参数]
```

---

## 功能详解

### 1. 查看当前规则

**交互模式**：选择菜单 `1) 查看当前规则`

**命令行语法**：
```bash
natmgr list
# 或
natmgr ls
# 或
natmgr status
```

**输出示例**：

```
=== 当前 NAT 端口转发规则 ===

序号  协议     源端口范围         目标            目标端口   数据包
-------------------------------------------------------------------
1     tcp      8080               本机            80         1523
2     udp      20000:30000        192.168.1.5     443        89
3     udp      8443               本机            443        2456

提示：使用 'del <序号>' 删除，'save' 保存配置
```

**字段说明**：

| 字段 | 说明 |
|------|------|
| 序号 | 规则编号，用于删除操作 |
| 协议 | tcp / udp |
| 源端口范围 | 外部访问的端口或端口范围 |
| 目标 | 转发目标地址（本机或内网IP） |
| 目标端口 | 转发后的端口 |
| 数据包 | 已匹配的数据包数量 |

---

### 2. 添加转发规则

**交互模式**：选择菜单 `2) 添加转发规则`，按提示输入协议、端口等信息

**命令行语法**：
```bash
natmgr add <协议> <源端口> <目标>
```

**参数说明**：

| 参数 | 说明 | 示例 |
|------|------|------|
| 协议 | tcp / udp / both | tcp |
| 源端口 | 外部端口或范围 | 8080 或 20000-30000 |
| 目标 | 端口 或 IP:端口 | 80 或 192.168.1.10:80 |

**示例**：

```bash
# TCP 转发到本机其他端口
sudo natmgr add tcp 8080 80

# UDP 端口范围转发（Hysteria 端口跳跃）
sudo natmgr add udp 20000-30000 443

# 转发到内网其他服务器
sudo natmgr add tcp 8080 192.168.1.50:80

# TCP + UDP 同时转发
sudo natmgr add both 443 8443
```

---

### 3. 删除转发规则

**交互模式**：选择菜单 `3) 删除转发规则`，按提示输入序号

**命令行语法**：
```bash
# 删除指定序号规则
natmgr del <序号>

# 删除所有规则
natmgr del all
```

**示例**：

```bash
# 删除第 1 条规则
sudo natmgr del 1

# 删除多条规则
sudo natmgr del 1 3 5

# 清空所有规则
sudo natmgr del all
```

---

### 4. 保存规则配置

将当前 iptables 规则保存到配置文件，用于重启后恢复。

**交互模式**：选择菜单 `4) 保存规则配置`

**命令行语法**：
```bash
natmgr save
```

**输出示例**：

```
=== 保存规则到配置文件 ===
✓ 已保存 2 条规则到 /etc/nat-manager.conf
配置文件预览：
# NAT Manager Config - 2024-01-15 10:30:25
#  Generated by natmgr
*nat
:PREROUTING ACCEPT [0:0]
... 共 8 行
```

---

### 5. 恢复规则配置

从配置文件恢复规则到 iptables。

**交互模式**：选择菜单 `5) 恢复规则配置`

**命令行语法**：
```bash
natmgr load
# 或
natmgr restore
```

---

### 6. 查看操作日志

**交互模式**：选择菜单 `6) 查看操作日志`

**命令行语法**：
```bash
natmgr log
# 或
natmgr logs
```

**输出示例**：

```
=== 操作日志（最近20条）===

[2024-01-15 10:30:25] 添加规则: 8080/tcp -> :80
[2024-01-15 10:32:10] 添加规则: 20000-30000/udp -> 192.168.1.5:443
[2024-01-15 10:35:00] 保存规则: 2 条
[2024-01-15 14:20:15] 删除规则 #1
```

---

## 常见使用场景

### 场景一：Hysteria 端口跳跃

Hysteria 协议支持端口跳跃功能，需要将大量 UDP 端口转发到实际服务端口：

```bash
# 将 20000-30000 的 UDP 流量转发到本机 443
sudo natmgr add udp 20000-30000 443
sudo natmgr save
```

### 场景二：多网站反向代理

将不同端口转发到内网不同服务器：

```bash
# 网站 A
sudo natmgr add tcp 8080 192.168.1.10:80

# 网站 B
sudo natmgr add tcp 8081 192.168.1.11:80

# 网站 C（HTTPS）
sudo natmgr add tcp 8443 192.168.1.12:443

sudo natmgr save
```

### 场景三：临时端口映射

临时将外部端口映射到开发环境：

```bash
# 快速添加
sudo natmgr add tcp 9090 3000

# 使用完毕后删除
sudo natmgr list
sudo natmgr del 1
```

### 场景四：服务器迁移

源服务器保存配置，目标服务器恢复：

```bash
# 在源服务器上
sudo natmgr save
scp /etc/nat-manager.conf root@new-server:/etc/

# 在目标服务器上
sudo natmgr load
sudo natmgr save
```

---

## 故障排查

### Q: 提示 "需要使用 root 权限运行"

**原因**：iptables 修改需要 root 权限。

**解决**：
```bash
sudo natmgr
```

### Q: 规则添加成功但无法访问

**原因1**：未开启 IP 转发功能。

**解决**：
```bash
# 临时开启
sudo sysctl -w net.ipv4.ip_forward=1

# 永久开启（编辑 /etc/sysctl.conf）
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

**原因2**：防火墙阻止了转发。

**解决**：
```bash
# 允许转发（示例）
sudo iptables -A FORWARD -p tcp --dport 80 -j ACCEPT
sudo iptables -A FORWARD -p tcp --sport 80 -j ACCEPT
```

### Q: 重启后规则丢失

**原因**：未保存配置或未设置开机恢复。

**解决**：
```bash
# 保存配置
sudo natmgr save

# 设置开机自动恢复（systemd）
sudo systemctl enable nat-restore.service
```

### Q: 配置文件恢复失败

**原因**：配置文件格式可能损坏。

**解决**：
```bash
# 检查配置文件
cat /etc/nat-manager.conf

# 手动修复或清空重建
sudo rm /etc/nat-manager.conf
sudo natmgr save
```

---

## 注意事项

1. **安全性**：确保只有受信任的 IP 能访问转发端口，建议配合防火墙使用
2. **端口冲突**：添加规则前确认端口未被其他服务占用
3. **配置备份**：重要配置建议定期备份 `/etc/nat-manager.conf`
4. **日志清理**：日志文件 `/var/log/nat-manager.log` 会持续增长，建议配置 logrotate
5. **兼容性**：支持 IPv4 和 IPv6（使用 `-6` 参数）

---

## 卸载方法

```bash
# 1. 清空所有规则
sudo natmgr del all

# 2. 删除文件
sudo rm -f /usr/local/bin/natmgr
sudo rm -f /etc/nat-manager.conf
sudo rm -f /var/log/nat-manager.log

# 3. 删除 systemd 服务（如果安装时创建）
sudo systemctl disable nat-restore.service 2>/dev/null
sudo rm -f /etc/systemd/system/nat-restore.service
sudo systemctl daemon-reload

echo "NAT Manager 已卸载"
```
